# SSH Key Management Guide

The Security Compliance CLI provides comprehensive SSH key management for testing scenarios where password authentication is disabled. This includes both installation and removal of SSH keys for secure testing workflows.

## Overview

The SSH key management system allows you to:
- **Install SSH keys**: Generate temporary keys or use existing ones
- **Remove SSH keys**: Clean up test keys for security
- **Detect remaining keys**: Automatic warnings about test keys left on devices
- **Manage key lifecycle**: Configurable validity periods and cleanup

## Quick Start

### Install SSH Key

```bash
# Generate a temporary key (valid for 1 hour) and install it
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key

# Generate a key valid for 8 hours
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key --key-validity-hours 8

# Save the generated private key for later use
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --save-private-key ./temp_ssh_key \
    --key-validity-hours 24
```

### Remove SSH Keys

```bash
# Remove all temporary keys generated by this tool
security-compliance-cli --serial-device /dev/ttyUSB0 uninstall-ssh-key --remove-temp-keys

# Remove a specific key by public key file
security-compliance-cli uninstall-ssh-key --public-key-file ~/.ssh/id_rsa.pub

# Remove keys matching a pattern
security-compliance-cli uninstall-ssh-key --key-pattern "*temp*"
```

## SSH Key Installation

### Basic Usage (Generate Temporary Key)

```bash
# Generate a temporary key (valid for 1 hour) and install it
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key

# Generate a key valid for 8 hours
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key --key-validity-hours 8

# Save the generated private key for later use
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --save-private-key ./temp_ssh_key \
    --key-validity-hours 24
```

### Using Existing Public Key

```bash
# Install an existing public key
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --public-key-file ~/.ssh/id_rsa.pub
```

### Advanced Options

```bash
# Full configuration example
security-compliance-cli \
    --serial-device /dev/ttyUSB0 \
    --serial-username root \
    --serial-password mypassword \
    install-ssh-key \
    --target-user fio \
    --key-validity-hours 12 \
    --save-private-key ./my_test_key \
    --test-connection
```

## SSH Key Removal

### Remove Temporary Keys

```bash
# Remove all temporary keys generated by this tool
security-compliance-cli --serial-device /dev/ttyUSB0 uninstall-ssh-key --remove-temp-keys

# Remove temporary keys via SSH (if already connected)
security-compliance-cli uninstall-ssh-key --remove-temp-keys --target-user fio
```

### Remove Specific Keys

```bash
# Remove a specific key by public key file
security-compliance-cli uninstall-ssh-key --public-key-file ~/.ssh/id_rsa.pub

# Remove by private key file (derives public key)
security-compliance-cli uninstall-ssh-key --private-key-file ./temp_key

# Remove keys matching a pattern
security-compliance-cli uninstall-ssh-key --key-pattern "*temp-key*"
security-compliance-cli uninstall-ssh-key --key-pattern "*test*"
```

### Verification Options

```bash
# Remove keys and verify removal
security-compliance-cli uninstall-ssh-key --remove-temp-keys --verify-removal

# Remove without verification (faster)
security-compliance-cli uninstall-ssh-key --remove-temp-keys --no-verify-removal
```

## Installation Command Options

### Connection Options (Global)
- `--serial-device`: Serial device path (e.g., `/dev/ttyUSB0`, `COM3`)
- `--serial-username`: Username for serial login
- `--serial-password`: Password for serial login
- `--baud-rate`: Serial baud rate (default: 115200)

### Key Management Options
- `--public-key-file`: Path to existing SSH public key file
- `--key-validity-hours`: Validity period for generated keys (default: 1 hour)
- `--save-private-key`: Path to save generated private key
- `--target-user`: Username to install the key for
- `--test-connection`: Test SSH connection after installation (default: true)

## Removal Command Options

### Key Selection Options
- `--public-key-file`: Remove specific public key from file
- `--private-key-file`: Remove key corresponding to private key
- `--remove-temp-keys`: Remove all temporary keys from this tool
- `--key-pattern`: Remove keys matching pattern (supports wildcards)

### Target Options
- `--target-user`: Username to remove keys from
- `--verify-removal`: Test that removed keys no longer work

## Key Generation Details

### Temporary Keys
When no `--public-key-file` is specified, the tool generates a new Ed25519 SSH key pair:
- **Algorithm**: Ed25519 (modern, secure, fast)
- **Default Validity**: 1 hour
- **Comment**: Includes generation timestamp and expiration time
- **Format**: OpenSSH compatible

### Key Expiration
Generated keys include expiration information in the comment field:
```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... security-compliance-cli-temp-key-20250107-143022 expires:2025-01-07 15:30:22 UTC
```

**Note**: The expiration is informational only. The key remains valid on the target system until manually removed.

## Security Warnings

### Automatic Detection
When running tests, the tool automatically checks for remaining temporary keys and warns:

```
âš ï¸  SECURITY WARNING: 2 temporary test keys remain on the device!
ðŸ”‘ These keys may allow unauthorized access to the device:
   1. AAAAC3Nz...567890 security-compliance-cli-temp-key-20250107-143022
   2. AAAAC3Nz...123456 security-compliance-cli-temp-key-20250107-150000

ðŸ§¹ To remove all temporary keys, run:
   security-compliance-cli uninstall-ssh-key --remove-temp-keys --target-user root

ðŸ’¡ For security, consider removing these keys before deploying to production!
```

### Manual Cleanup
Always clean up test keys after testing:

```bash
# Check for remaining keys manually
ssh user@device "grep 'security-compliance-cli-temp-key' ~/.ssh/authorized_keys"

# Clean up all temporary keys
security-compliance-cli uninstall-ssh-key --remove-temp-keys
```

## Workflow Examples

### Development Testing
```bash
# 1. Install temporary key for 2 hours
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --key-validity-hours 2 \
    --save-private-key ./dev_key

# 2. Run tests via SSH
security-compliance-cli --identity-file ./dev_key test

# 3. Clean up when done
security-compliance-cli uninstall-ssh-key --remove-temp-keys
```

### CI/CD Integration
```bash
# 1. Install key from CI system
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --public-key-file $CI_SSH_PUBLIC_KEY \
    --target-user root

# 2. Run tests via SSH
security-compliance-cli --identity-file $CI_SSH_PRIVATE_KEY test

# 3. Always clean up (even on failure)
security-compliance-cli uninstall-ssh-key --public-key-file $CI_SSH_PUBLIC_KEY || true
```

### Long-term Testing
```bash
# 1. Install key with extended validity
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --key-validity-hours 24 \
    --save-private-key ~/.ssh/test_device_key \
    --target-user fio

# 2. Use for multiple test sessions
security-compliance-cli --identity-file ~/.ssh/test_device_key test
security-compliance-cli --identity-file ~/.ssh/test_device_key detect

# 3. Clean up when project complete
security-compliance-cli uninstall-ssh-key \
    --public-key-file ~/.ssh/test_device_key.pub
```

## File Operations

### Installation Operations
The tool performs these operations on the target device:
```bash
# Create .ssh directory
mkdir -p /home/USERNAME/.ssh

# Set directory permissions
chmod 700 /home/USERNAME/.ssh

# Add public key
echo "ssh-ed25519 ..." >> /home/USERNAME/.ssh/authorized_keys

# Set file permissions
chmod 600 /home/USERNAME/.ssh/authorized_keys

# Set ownership
chown -R USERNAME:USERNAME /home/USERNAME/.ssh
```

### Removal Operations
The tool safely removes keys by:
```bash
# Read current authorized_keys
cat /home/USERNAME/.ssh/authorized_keys

# Filter out matching keys (done in memory)
# Write back remaining keys
cat > /home/USERNAME/.ssh/authorized_keys << 'EOF'
[remaining keys]
EOF

# Restore permissions
chmod 600 /home/USERNAME/.ssh/authorized_keys
```

## Security Considerations

### Temporary Keys
- Default 1-hour validity provides good security/convenience balance
- Keys are not automatically removed from target (manual cleanup required)
- Private keys are stored in memory only (unless `--save-private-key` used)

### File Permissions
- Private key files saved with 600 permissions (owner read/write only)
- Target device SSH directory and files configured with proper permissions

### Connection Testing
- SSH connection test validates key installation
- Uses the same host/port configured for the tool
- Helps identify SSH server configuration issues

### Key Removal
- Safe removal process preserves other keys
- Verification option tests that removed keys no longer work
- Pattern matching allows flexible cleanup

## Troubleshooting

### Serial Connection Issues
```bash
# Check device permissions
ls -l /dev/ttyUSB*
sudo chmod 666 /dev/ttyUSB0  # Temporary fix

# Verify device is not in use
lsof /dev/ttyUSB0
```

### SSH Connection Test Failures
- Verify SSH server is running on target: `systemctl status ssh`
- Check SSH server configuration: `/etc/ssh/sshd_config`
- Ensure `PubkeyAuthentication yes` is set
- Check SSH server logs: `journalctl -u ssh`

### Key Installation Issues
- Verify target user exists: `id USERNAME`
- Check home directory permissions
- Ensure sufficient disk space in home directory

### Key Removal Issues
- Verify authorized_keys file exists and is readable
- Check file permissions on .ssh directory
- Ensure user has write access to authorized_keys file

## Integration with Other Commands

After installing an SSH key, you can use other tool commands via SSH:

```bash
# Install key via serial
security-compliance-cli --serial-device /dev/ttyUSB0 install-ssh-key \
    --save-private-key ./device_key

# Run tests via SSH using the installed key
security-compliance-cli --identity-file ./device_key test

# Detect device type via SSH
security-compliance-cli --identity-file ./device_key detect

# Clean up when done
security-compliance-cli uninstall-ssh-key --remove-temp-keys
```

This workflow enables seamless transition from serial-based key installation to SSH-based testing and operations, with proper cleanup for security.
